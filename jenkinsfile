#!/usr/bin/env groov
pipeline {
  environment {
    imageName = "xcarlosr/mfe-dashboard"
    dockerhubId = 'dockerhub'
    dockerImage = ''
  }

  agent any
  tools { nodejs "node" }

  stages {
    stage("Updade Source"){
      steps {
        // deleteDir()
        checkout scm
      }
    }

    stage('NPM Install') {
      steps {
        script {
            sh 'npm i'
        }
      }
    }

    // stage('Test') {
    //     withEnv(["CHROME_BIN=/usr/bin/chromium-browser"]) {
    //       sh 'ng test --progress=false --watch false'
    //     }
    //     junit '**/test-results.xml'
    // }

    // stage('Lint') {
    //     sh 'ng lint'
    // }

    stage('Build All Projects ') {
      steps {
        script {
          sh 'npx nx build dashboard'
        }
      }
    }

    stage('Docker') {
      stages {
          stage('Create Image') {
            steps {
              script {
                dockerImage = docker.build("$imageName:$BUILD_NUMBER","-f ./apps/dashboard/Dockerfile .")
              }
            }
          }
          stage('Push Image') {
              steps {
                echo "Push Image..."
                script {
                      docker.withRegistry('', dockerhubId){
                      dockerImage.push('latest')
                      dockerImage.push("$BUILD_NUMBER")
                    }
                }
            }
          }

          stage('Remove Unused docker image') {
            steps{
              echo "Remove Unused docker image..."
              sh "docker rmi $imageName:latest"
              sh "docker rmi $imageName:$BUILD_NUMBER"
            }
          }
      }
    }
  }
}
